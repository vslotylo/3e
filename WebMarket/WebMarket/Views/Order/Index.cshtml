@using WebMarket.Extensions
@model WebMarket.Models.Cart
@{
    ViewBag.Title = "Оформлення замовлення";
}
@section breadCrumb {
    <li class="active">@ViewBag.Title</li>
}
@section scripts
{
    <script type="text/javascript">
    $(document).ready(function () {
        function validate(control, regex) {
            if (typeof(regex) === 'undefined') regex = null;
            var val = control.val();
            var isValid = false;
            if(regex != null)
            {
                isValid = regex.test(val);
            }
            if (!isValid) {
                    control.parents('.control-group').addClass('error');
                    control.parents('.control-group').removeClass('success');
                    control.parent().next().removeClass('hidden');
                    return false;
            }
            else {
                control.parents('.control-group').removeClass('error');
                control.parents('.control-group').addClass('success');
                control.parent().next().addClass('hidden');
                return true;
            }
        }

        var isUserNameValid;
        var isPhoneValid;
        var isEmailValid;

        function canPurchase()
        {
            if(isUserNameValid && isPhoneValid && isEmailValid)
            {
                $('#purchase').removeClass('disabled');
                return true;
            }
            else
            {
                $('#purchase').addClass('disabled'); 
                return false;
            }
        }

        $("#userName").focusout(function () {
            isUserNameValid = validate($(this),/\D{3,}/);
            canPurchase();
        });

        $("#phone").focusout(function () {
            isPhoneValid = validate($(this), /^([0-9\(\)\/\+ \-]{7,})$/);       
            canPurchase();     
        });

        $("#email").focusout(function () {
            isEmailValid = validate($(this), @Html.Raw(@"/.+\@.+\..+/"));            
            canPurchase();
        });

        $('#purchase').on('click', function (e) {
            if(!canPurchase())
             return;
                        
            var userName = $('#userName').val();
            var phone = $('#phone').val();
            var email = $('#email').val();
            var comment = $('#comment').val();
            var city = $('#city').val();
            var address = $('#address').val();
             $.post("/order/add", { user: userName, phone: phone, email : email, city: city, address: address, comment : comment })
            .done(function (e) {
                $('#orderSubmitted').modal('show');
            });
        });

        $('#close').on('click', function (e)
        {
            $('#orderSubmitted').modal('hide');
            window.location = "/home";
        });
        
        $('#modalclose').on('click', function (e)
        {
            $('#orderSubmitted').modal('hide');
            window.location = "/home";
        });
    }); 
</script>
}

@if (!Model.Items.Any())
{
    <div class="alert alert-info">
        <strong>Увага!</strong><p>Щоб зробити замовлення спершу добавте товари в корзину.</p>
    </div>
}
else
{
    <div>
        <div class="row-fluid">
            <div class="span6">
                <div class="well">
                    <div class="form-horizontal">
                        <div class="control-group">
                            <label for="userName" class="control-label">
                                Ім'я*:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-user"></i></span>
                                    <input type="text" id="userName" placeholder="Ім'я">
                                </div>
                                <div class="help-inline hidden">
                                    Невірні дані.<i class='icon-exclamation-sign'></i></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="phone" class="control-label">
                                Мобільний телефон*:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-bell"></i></span>
                                    <input type="tel" id="phone" title="Введений Вами телефон не відповідає формату."
                                        placeholder="###-###-##-##">
                                </div>
                                <div class="help-inline hidden">
                                    Невірні дані.<i class='icon-exclamation-sign'></i></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="email" class="control-label">
                                Пошта*:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-envelope"></i></span>
                                    <input type="text" id="email" placeholder="">
                                </div>
                                <div class="help-inline hidden">
                                    Невірні дані.<i class='icon-exclamation-sign'></i></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="city" class="control-label">
                                Місто*:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-envelope"></i></span>
                                    <input type="text" id="city" placeholder="">
                                </div>
                                <div class="help-inline hidden">
                                    Невірні дані.<i class='icon-exclamation-sign'></i></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="address" class="control-label">
                                Адреса*:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-envelope"></i></span>
                                    <input type="text" id="address" placeholder="">
                                </div>
                                <div class="help-inline hidden">
                                    Невірні дані.<i class='icon-exclamation-sign'></i></div>
                            </div>
                        </div>                        
                        <div class="control-group">
                            <label for="comment" class="control-label">
                                Коментар:</label>
                            <div class="controls">
                                <div class="input-prepend">
                                    <span class="add-on"><i class="icon-comment"></i></span>
                                    <textarea id="comment" cols="1" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="span6">
                <div class="well">
                    <strong>Ваше замовлення</strong><a href="@Url.Action("index", "cart")" class="pull-right">
                        редагувати</a>
                    <table class="table">
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>
                                        @item.Product.Name
                                    </td>
                                    <td>
                                        @item.Product.PriceUah грн. * @item.Quantity
                                    </td>
                                    <td>
                                        <span class="priceUahSmall">@item.TotalItemPrice.ToFormatString() грн.</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    @Html.Partial("TotalSum", Model.TotalPrice);
                    <br />
                </div>
            </div>
        </div>
        <button id="purchase" type="btn btn-large btn-primary" class="btn btn-large btn-primary pull-right disabled">
            Відправити замовлення</button>
        <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1"
            class="modal hide fade" id="orderSubmitted" style="display: none;">
            <div class="modal-header">
                <button id="modalclose" aria-hidden="true" data-dismiss="modal" class="close" type="button">
                    ×</button>
                <h3 id="myModalLabel">
                    Замовлення прийнято</h3>
            </div>
            <div class="modal-body">
                <div>
                    Ваше замовлення прийнято. Наш менеджер звяжеться з вами в найблищий час! Дякуємо
                    за покупку!
                </div>
            </div>
            <div class="modal-footer">
                <span>
                    <button id="close" class="btn btn-primary">
                        Гаразд</button>
                </span>
            </div>
        </div>
    </div>
}
